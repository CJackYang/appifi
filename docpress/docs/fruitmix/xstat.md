## Objective

`xstat` module is responsible for read and store the `xattr` data on file or folders.

For the sake of performance, it also returns `lstat` data to caller. Hence the `xstat` stands for `xattr` + `fs.stat`.

**using lstat rather than stat** to avoid following symbolic link.

## Data Structure Definition

There are two data structures.

One is stored as `xattr` using `user:fruitmix` as name, in json format, representing the decorated file metadata.

The other is returned by read function to upper layer, in JavaScript object format, representing a file or folder's decorated file system metadata.

### xattr in JSON format

example:

```json
{
  "uuid": "d10a0dce-7ff6-4cdd-b02b-f74fc863b0fd",
  "writelist": [],
  "readlist": [],
  "hash": "7803e8fa1b804d40d412bcd28737e3ae027768ecc559b51a284fbcadcd0e21be",
  "htime": 1482051736410,
  "magic": "JPEG"  
}
```

**uuid**

mandatory, a valid uuid v4 string

**writelist and readlist**

mandatory, both are uuid v4 string array, or both are null. It is not allowed for one is uuid array and the other are null. Empty array is OK.

**hash and htime**

optional, both exists or both are absent. One existing and the other absent is invalid.

`hash` is a sha256 string, can be validated by regex. `htime` is an integer, usually generated by `new Date().getTime()`.

**magic**

A predefined string, such as `JPEG`, or a number, used as `uninterested magic` version. Starting from 0. Bumped when more file-types supported.

#### bad format

If `xstat` reads a `xattr` that does not conform to above definition. It should be discarded and treated as a file or folder without `xattr` at all.

#### old format

In previous software version, there are one extra prop in JSON and magic property has different definition.

```json
{
  "owner": [],
  "magic": "JPEG image data, Exif standard: [TIFF image data, little-endian..."
}
```

If `xstat` module staring from this version, read a `xattr` containing `owner` prop, it should be considered an old version. And old version should be translated into new definition, instead of treating it as bad format.

If an old version is detected, and `magic` props exists, it should be truncated to predefined magic string, such as `JPEG`, or an number, representing `uninterested magic`. Again, this should not be treated as bad format.

#### uninterested magic version

Starting from current version (0.3), the responsibility of detecting file type is assigned to `xstat` module.

It works as:

1. using `file` command to extract magic string.
2. if magic string starts with `JPEG image data`, the magic prop is assigned to `JPEG` (string).
3. if magic string does not starts with `JPEG image data` the magic prop is assigned to 0 (number).

0 indicates that in version 0, the type of this file is not interested. This value should be hard-coded as a constant in source code. Named as `UNINTERESTED_MAGIC_VERSION`.

Next time, if we are interested also gif file, we bump this number to 1. When `xstat` module read a `xattr` with UNINTERESTED_MAGIC_VERSION less than 1, it knows that it should run `file` command against the file again, to see if magic string starts with `GIF image data`, if so, the magic prop should be set to `GIF`, otherwise, it should be set to new UNINTERESTED_MAGIC_VERSION, which is 1, to avoid running `file` command again during next `xstat` reading.

### xstat in JavaScript Object format

Props and functions in `fs.stat` is not listed.

```js
{
  uuid: 'd10a0dce-7ff6-4cdd-b02b-f74fc863b0fd',
  writelist: [],
  readlist: [],
  hash: '7803e8fa1b804d40d412bcd28737e3ae027768ecc559b51a284fbcadcd0e21be',
  magic: 'JPEG'
}
```

**uuid, writelist, readlist**

same as JSON counterpart.

**hash and htime**

`htime` is silently dropped. `xstat` use this prop internally, and never return object with this prop.

**magic**

optional, If magic is a predefined string, it is included in `xstat` object. If it is UNINTERESTED_MAGIC_VERSION, it is excluded. `xstat` object does not have this prop.

## Functions

### readTimeStamp

// TODO ?? should this function provide a uuid? seems yes, if all operation is applied to a node with known uuid

A convenience function, returning `mtime` of given file or folders.

### readXstat

This is the main function of `xstat` module.

```js
function readXstat(target, callback)
```

This definition is different from previous version in that it eliminate an optional parameter.

If the target does not have `xattr`, a new `xattr` is generated with random UUID, writelist and readlist set to null (implicit), and magic should be extract from `file` command and properly set.

If the target already have `xattr`, it should be validated. If it is neither valid current version or valid old version, it is discarded. A brand new `xattr` should be generated.

If it has an old version (valid and has owner prop):

* if magic exists, it should be translated.
* if magic does not exist, it should be calculated.
* if hash / htime exists and valid, they should be reused.
* if hash / htime exists but not valid, either bad format or outdated, they should be discarded.

If the target already have new version `xattr`

* hash / htime props should be checked, and dropped if necessary.
* if magic is predefined string, intact.
* if magic is number, equals to or larger than current UNINTERESTED_MAGIC_VERSION, intact.
* if magic is number, less than current UNINTERESTED_MAGIC_VERSION, magic should be re-calculated.

This function should have plenty of unit testing, making sure both returned `xstat` object and `xattr` json are correct.

### updateXattrPermission

```js
function updateXattrPermission(target, uuid, writelist, readlist, callback)
```

writelist and readlist must be both null or both valid uuid array.

If a user is in both writelist and readlist, it should be removed out of readlist.

### updateXattrHash

```js
function updateXattrHash(target, uuid, hash, htime, callback)
```

`htime` is used to make sure the hash value is correct, even if the file is modified when hashing the file.

Each time a job is allocated to calc hash, it should first retrieve the `mtime` before starting calculation. After the calculation is done, it should provide both `uuid` and `htime`, as well as calculated hash to invoke this function. This function will check the `mtime` again. If the timestamp is not equal, it knows that the hash cannot be used and return error.

### copyXattr

```js
function copyXattr(dst, src, callback)
```

This function is used for overwriting an existing file with new one and keeping the uuid.
